<script>
// ...mantenha o resto do c√≥digo

// === SUBSTITUA a ensureSignaturePad inteira por esta ===
let signaturePad, canv;
function ensureSignaturePad(){
  if (signaturePad) return;
  canv = document.getElementById('signaturePad');
  const fit = () => {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const rect = canv.getBoundingClientRect();
    canv.width = rect.width * ratio;
    canv.height = rect.height * ratio;
    canv.getContext('2d').scale(ratio, ratio);
  };
  fit();

  signaturePad = new SignaturePad(canv, {
    backgroundColor:'#fff',
    penColor:'#111827',
    minWidth:.7,
    maxWidth:2,
    throttle:0,
    // üëá √© aqui que garantimos que o bot√£o apare√ßa ao terminar um tra√ßo
    onEnd: () => {
      if (!signaturePad.isEmpty()) {
        // Atualiza a pr√©via da assinatura do PDF
        const img = document.getElementById('pv_assinatura');
        if (img) img.src = signaturePad.toDataURL('image/png');
        // Mostra o bot√£o
        const row = document.getElementById('pdfRow');
        if (row) row.style.display = 'flex';
      }
    }
  });

  // Limpar assinatura -> esconde bot√£o
  document.getElementById('btnLimpar').addEventListener('click', (e)=>{
    e.preventDefault();
    signaturePad.clear();
    const img = document.getElementById('pv_assinatura');
    if (img) img.removeAttribute('src');
    const row = document.getElementById('pdfRow');
    if (row) row.style.display = 'none';
  });

  // Refit em resize
  window.addEventListener('resize', ()=>{
    if (!signaturePad) return;
    const data = signaturePad.toData();
    fit();
    signaturePad.clear();
    signaturePad.fromData(data);
  });
}

// === SUBSTITUA o handler do checkbox por este ===
document.getElementById('aceite').addEventListener('change', (e)=>{
  const sigWrap = document.getElementById('sigWrap');
  const pdfRow  = document.getElementById('pdfRow');
  if (e.target.checked){
    sigWrap.style.display = 'block';
    ensureSignaturePad();
    // Se a pessoa j√° tinha assinado antes (raro), garante o bot√£o
    if (signaturePad && !signaturePad.isEmpty()) {
      pdfRow.style.display = 'flex';
    }
  } else {
    sigWrap.style.display = 'none';
    pdfRow.style.display  = 'none';
    if (signaturePad) signaturePad.clear();
    const img = document.getElementById('pv_assinatura');
    if (img) img.removeAttribute('src');
  }
});

// === (Opcional, mas √∫til) chame isto logo ap√≥s criar pdfRow ===
// Garante consist√™ncia caso chegue na tela j√° com aceite marcado por algum motivo
(function initPdfRow(){
  const pdfRow = document.getElementById('pdfRow');
  if (pdfRow) pdfRow.style.display = 'none';
})();
</script>
