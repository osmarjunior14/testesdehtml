<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DUO Academia — Autorização p/ Terceiros (8 etapas) — PDF fixo A4</title>
<style>
  :root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --fg:#e5e7eb; --line:#1f2937; --brand:#3b82f6; --ok:#22c55e; --danger:#ef4444; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;background:var(--bg);color:var(--fg)}
  .wrap{max-width:980px;margin:0 auto;padding:24px}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:16px 0 24px;border-bottom:1px solid var(--line)}
  h1{font-size:20px;margin:0;font-weight:700}.badge{font-size:12px;color:var(--muted)}

  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .card h2{font-size:18px;margin:0 0 12px}
  .row-1{display:grid;grid-template-columns:1fr;gap:12px}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}.req::after{content:" *";color:var(--danger);font-weight:700}
  input,select,textarea{width:100%;background:#0b1220;border:1px solid #1c2536;color:var(--fg);border-radius:10px;padding:12px;outline:none}
  input:focus,textarea:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(59,130,246,.25)}
  .help{font-size:12px;color:var(--muted);margin-top:4px}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px;justify-content:space-between}
  .btn{appearance:none;border:1px solid #2a3448;background:#162136;color:#dbeafe;padding:10px 14px;border-radius:10px;cursor:pointer;font-size:14px}
  .btn.ok{background:var(--ok);border-color:var(--ok);color:#001a07}.btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}

  .terms{border:1px dashed #334155;border-radius:12px;padding:12px;background:#0b1220;overflow:hidden}
  .sig-wrap{background:#0b1220;border:1px solid #1c2536;border-radius:12px;padding:12px}
  .sig-wrap canvas{width:100%;height:220px;background:#fff;border-radius:8px;border:1px solid #334155;display:block;touch-action:none;cursor:crosshair}

  .steps{display:flex;gap:6px;justify-content:center;margin:10px 0 16px}
  .dot{width:8px;height:8px;border-radius:999px;background:#1f2937;opacity:.6}
  .dot.active{background:var(--brand);opacity:1}
  .screen{display:none}.screen.active{display:block}
  .titlecenter{font-size:14px;text-align:center;margin-bottom:8px;color:var(--muted)}
  footer{margin-top:20px;font-size:12px;color:var(--muted);text-align:center}

  /* ===== Área fixa do PDF (OFFSCREEN) ===== */
  #pdfRoot{ position:fixed; left:-10000px; top:0; width:0; height:0; overflow:hidden; pointer-events:none; }
  #printArea{
    background:#fff; color:#111; width:794px; min-height:1123px;
    padding:28mm 16mm; border:1px solid #ddd; border-radius:6px;
  }
  #printArea h3{margin:0 0 8px}
  #printArea small{color:#555}
  #printArea .section{margin-top:14px}
  #printArea table{width:100%;border-collapse:collapse;font-size:13px}
  #printArea th,#printArea td{border:1px solid #ccc;padding:6px 8px;text-align:left}
  #printArea .sign-area{display:flex;gap:16px;align-items:flex-end;margin-top:24px}
  #printArea .sign-box{flex:1}
  #printArea .sign-img{max-width:100%;max-height:130px;border:none;background:transparent;display:block;margin:0 auto;object-fit:contain}
  #printArea .line{height:1px;background:#ccc;margin:6px 0}
  #printArea .brand{display:flex;align-items:center;gap:10px}
  #printArea .brand img.logo{height:38px;width:auto;display:block}

  /* MAIÚSCULO */
  input[type="text"], input:not([type]), textarea { text-transform: uppercase; }
  input[type="date"], input[type="number"] { text-transform: none; }

  /* Legibilidade no PDF */
  #printArea, #printArea *{
    font-family: Arial, Helvetica, sans-serif;
    font-kerning: none; letter-spacing:.2px; word-spacing:.4px; line-height:1.25;
    -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
  }
  #printArea table th, #printArea table td{ letter-spacing:.3px; }

  /* Checkbox aceitar — branco/verde (iOS OK) */
  #aceite{
    -webkit-appearance:none; appearance:none; width:22px; height:22px; border:2px solid #fff; border-radius:6px;
    background:transparent; display:inline-grid; place-content:center; outline:2px solid #fff; outline-offset:2px; cursor:pointer;
  }
  #aceite::after{ content:""; width:6px; height:10px; border-right:3px solid #fff; border-bottom:3px solid #fff;
                  transform:scale(0) rotate(45deg); transition:transform .12s ease-in-out; }
  #aceite:checked{ background:#22c55e; border-color:#22c55e; outline-color:#22c55e; }
  #aceite:checked::after{ transform:scale(1) rotate(45deg); }

  @media(max-width:760px){ input,select,textarea{font-size:16px} .sig-wrap canvas{height:180px} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>DUO Academia · Autorização para uso de cartão por terceiros</h1>
      <div class="badge">Responda cada etapa. Ao final, gere o PDF.</div>
    </div>
    <div class="badge">v3.8 (8 etapas)</div>
  </header>

  <div class="steps" id="steps"></div>
  <div class="titlecenter"><span id="titStep">Etapa 1 de 8</span></div>

  <!-- 1) Nome do titular -->
  <section class="screen active" id="s0">
    <div class="card">
      <h2>1) Nome do titular do cartão</h2>
      <div class="row-1"><div><label for="titular_nome">Nome completo</label><input id="titular_nome" placeholder="Ex.: JOÃO DA SILVA" type="text" /></div></div>
      <div class="btns"><span></span><button type="button" class="btn ok" id="n0">Próximo</button></div>
    </div>
  </section>

  <!-- 2) CPF titular -->
  <section class="screen" id="s1">
    <div class="card">
      <h2>2) CPF do titular do cartão</h2>
      <div class="row-1"><div><label for="titular_cpf">CPF</label><input id="titular_cpf" inputmode="numeric" maxlength="14" placeholder="000.000.000-00" type="text" /><div class="help">Validado ao gerar o PDF.</div></div></div>
      <div class="btns"><button type="button" class="btn" id="p1">Voltar</button><button type="button" class="btn ok" id="n1">Próximo</button></div>
    </div>
  </section>

  <!-- 3) 4 dígitos -->
  <section class="screen" id="s2">
    <div class="card">
      <h2>3) Quatro últimos dígitos do cartão</h2>
      <div class="row-1"><div><label for="ultimos4">Últimos 4 dígitos</label><input id="ultimos4" inputmode="numeric" maxlength="4" placeholder="1234" type="text" /><div class="help">Apenas 4 dígitos.</div></div></div>
      <div class="btns"><button type="button" class="btn" id="p2">Voltar</button><button type="button" class="btn ok" id="n2">Próximo</button></div>
    </div>
  </section>

  <!-- 4) Bandeira -->
  <section class="screen" id="s3">
    <div class="card">
      <h2>4) Bandeira do cartão</h2>
      <div class="row-1"><div><label for="bandeira" class="req">Bandeira</label><select id="bandeira" required aria-required="true"><option value="" selected disabled>Selecione…</option><option>Visa</option><option>Mastercard</option><option>Elo</option><option>Amex</option><option>Hipercard</option><option>Outros</option></select></div></div>
      <div class="btns"><button type="button" class="btn" id="p3">Voltar</button><button type="button" class="btn ok" id="n3">Próximo</button></div>
    </div>
  </section>

  <!-- 5) Nome contratante -->
  <section class="screen" id="s4">
    <div class="card">
      <h2>5) Nome completo do contratante do plano</h2>
      <div class="row-1"><div><label for="contratante_nome">Nome completo</label><input id="contratante_nome" placeholder="Ex.: MARIA OLIVEIRA" type="text" /></div></div>
      <div class="btns"><button type="button" class="btn" id="p4">Voltar</button><button type="button" class="btn ok" id="n4">Próximo</button></div>
    </div>
  </section>

  <!-- 6) CPF contratante -->
  <section class="screen" id="s5">
    <div class="card">
      <h2>6) CPF do contratante</h2>
      <div class="row-1"><div><label for="contratante_cpf">CPF</label><input id="contratante_cpf" inputmode="numeric" maxlength="14" placeholder="000.000.000-00" type="text" /></div></div>
      <div class="btns"><button type="button" class="btn" id="p5">Voltar</button><button type="button" class="btn ok" id="n5">Próximo</button></div>
    </div>
  </section>

  <!-- 7) Termo + assinatura (apenas PARÁGRAFO ÚNICO) -->
  <section class="screen" id="s6">
    <div class="card">
      <h2>7) Termo de autorização + rúbrica</h2>

      <div class="terms" aria-readonly="true">
        <table style="width:100%; border-collapse:collapse; font-size:13px; background:#0b1220">
          <tr>
            <th style="text-align:left; border:1px solid #334155; padding:8px; background:#0f1524; color:#e5e7eb">
              PARÁGRAFO ÚNICO
            </th>
          </tr>
          <tr>
            <td style="border:1px solid #334155; padding:10px 12px; color:#e5e7eb; font-size:14px; line-height:1.5; text-align:justify">
              O TITULAR autoriza a CONTRATADA a utilizar o cartão de crédito e/ou débito dele para realizar a adesão de
              algum contrato, produto ou serviço para o CONTRATANTE, assumindo responsabilidade em caso de eventuais
              situações interpessoais entre TITULAR e CONTRATANTE.
            </td>
          </tr>
        </table>
      </div>

      <label style="display:flex;align-items:center;gap:12px;margin-top:10px">
        <input id="aceite" type="checkbox" />
        <span>Li e concordo com o termo acima.</span>
      </label>

      <div class="row-1" style="margin-top:12px">
        <div>
          <label>Data da assinatura</label>
          <div id="data_assinatura_view" style="font-weight:700">--/--/----</div>
          <input id="data_assinatura" type="hidden" />
        </div>
      </div>

      <div class="sig-wrap" style="margin-top:10px">
        <label for="signaturePad">Assine no quadro abaixo</label>
        <canvas id="signaturePad" width="900" height="350" aria-label="Área para assinatura com o dedo ou mouse"></canvas>
        <div class="btns" style="justify-content:flex-start">
          <button type="button" class="btn" id="btnLimpar">Limpar</button>
        </div>
        <div class="help">Dica: gire o celular para paisagem se precisar de mais espaço.</div>
      </div>

      <div class="btns">
        <button type="button" class="btn" id="p6">Voltar</button>
        <button type="button" class="btn ok" id="n6">Próximo</button>
      </div>
    </div>
  </section>

  <!-- 8) Somente o botão Gerar PDF -->
  <section class="screen" id="s7">
    <div class="card">
      <h2>8) Gerar PDF</h2>
      <div class="help">Revise seus dados nas etapas anteriores. Ao tocar em “Gerar PDF”, o documento será exportado em A4.</div>
      <div class="btns" style="margin-top:12px">
        <button type="button" class="btn" id="p7">Voltar</button>
        <button type="button" class="btn ok" id="btnPDF" disabled>Gerar PDF</button>
        <button type="button" class="btn danger" id="btnReset">Resetar</button>
      </div>
      <footer>Dica: também funciona via <strong>Imprimir &gt; Salvar como PDF</strong>.</footer>
    </div>
  </section>
</div>

<!-- ====== Área OFFSCREEN usada só para exportar ====== -->
<div id="pdfRoot" aria-hidden="true">
  <div id="printArea">
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div class="brand">
        <img id="sheet_logo" class="logo" alt="Logo DUO" />
        <div>
          <h3 style="margin:0 0 2px;">DUO ACADEMIA</h3>
          <small style="font-size:6px;line-height:.9;display:block;margin-top:0">
            Av. Simoa Gomes, 726 – Heliópolis · R. Dom José, 187 – Santo Antônio<br>
            (87) 9 9666-0021 | (87) 9 9934-1230 · coordenacaoduoacademia@gmail.com
          </small>
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-size:12px;color:#444">Código: <span id="doc_id"></span></div>
        <div style="font-size:12px;color:#444">Data: <span id="doc_data"></span></div>
      </div>
    </div>
    <div class="line" style="height:1px;background:#ccc;margin:6px 0"></div>

    <div class="section">
      <table>
        <tr><th colspan="2">DADOS DO TITULAR DO CARTÃO</th></tr>
        <tr><td>Nome</td><td id="pv_titular_nome" class="ans"></td></tr>
        <tr><td>CPF</td><td id="pv_titular_cpf"></td></tr>
      </table>
    </div>

    <div class="section">
      <table>
        <tr><th colspan="2">DADOS DO CARTÃO UTILIZADO</th></tr>
        <tr><td>Últimos 4 dígitos</td><td id="pv_u4"></td></tr>
        <tr><td>Bandeira</td><td id="pv_bandeira" class="ans"></td></tr>
      </table>
    </div>

    <div class="section">
      <table>
        <tr><th colspan="2">DADOS DO CONTRATANTE DO PLANO</th></tr>
        <tr><td>Nome</td><td id="pv_contratante_nome" class="ans"></td></tr>
        <tr><td>CPF</td><td id="pv_contratante_cpf"></td></tr>
      </table>
    </div>

    <div class="section" id="paragrafo-unico">
      <table>
        <tr><th>PARÁGRAFO ÚNICO</th></tr>
        <tr>
          <td style="font-size:12px; line-height:1.35; text-align:justify">
            O TITULAR autoriza a CONTRATADA a utilizar o cartão de crédito e/ou débito dele
            para realizar a adesão de algum contrato, produto ou serviço para o CONTRATANTE,
            assumindo responsabilidade em caso de eventuais situações interpessoais entre
            TITULAR e CONTRATANTE.
          </td>
        </tr>
      </table>
    </div>

    <div class="section sign-area">
      <div class="sign-box">
        <div style="margin-bottom:6px">Assinante: <span id="pv_quem">Titular do Cartão</span></div>
        <img id="pv_assinatura" class="sign-img" alt="Assinatura" />
        <div class="line"></div>
        <div style="font-size:12px;color:#555">Assinatura (rúbrica)</div>
      </div>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  const $ = (s)=>document.querySelector(s);
  const onlyDigits = v => (v||'').replace(/\D+/g,'');
  const U = s => (s || '').toLocaleUpperCase('pt-BR');
  const docId = () => new Date().toISOString().replace(/[-:TZ.]/g,'').slice(0,14);
  const slugUpper = s => (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().replace(/[^A-Z0-9]+/g,'');

  // Steps
  let step = 0, total = 8;
  const titStep = document.getElementById('titStep');
  function mountDots(){ const el = document.getElementById('steps'); el.innerHTML=''; for(let i=0;i<total;i++){ const d=document.createElement('div'); d.className='dot'+(i===0?' active':''); d.id='d'+i; el.appendChild(d);} }
  function go(i){
    step = Math.max(0, Math.min(total-1, i));
    for(let k=0;k<total;k++){ document.getElementById('s'+k).classList.toggle('active', k===step); document.getElementById('d'+k).classList.toggle('active', k<=step); }
    titStep.textContent = `Etapa ${step+1} de ${total}`;
    if(step === 6){
      requestAnimationFrame(()=>{
        const data = signaturePad ? signaturePad.toData() : null;
        resizeCanvasForHiDPI();
        if (signaturePad){ signaturePad.clear(); if (data && data.length) signaturePad.fromData(data); }
      });
    }
    updatePDFButton();
  }

  // Logo
  async function loadLogo(){
    const imgEl = $('#sheet_logo'); if(!imgEl) return;
    try{
      const resp = await fetch('logo.png', {cache:'no-store'});
      if(!resp.ok) throw 0;
      const blob = await resp.blob();
      const fr = new FileReader();
      fr.onload = ()=> imgEl.src = fr.result;
      fr.readAsDataURL(blob);
    }catch{ imgEl.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8Xw8AAoMBm6o7oDkAAAAASUVORK5CYII='; }
  }

  // Data
  function setTodayBR(){
    const d = new Date();
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = d.getFullYear();
    const iso = `${yy}-${mm}-${dd}`;
    $('#data_assinatura').value = iso;
    $('#doc_data').textContent = `${dd}/${mm}/${yy}`;
    $('#data_assinatura_view').textContent = `${dd}/${mm}/${yy}`;
  }

  // Máscaras
  const maskCPF = v => { v = onlyDigits(v).slice(0,11); return v.replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})$/,'$1-$2'); };
  document.addEventListener('input', e=>{
    if(e.target.id==='titular_cpf' || e.target.id==='contratante_cpf') e.target.value = maskCPF(e.target.value);
    if(e.target.id==='ultimos4') e.target.value = onlyDigits(e.target.value).slice(0,4);
    renderPreview(); updatePDFButton();
  });
  document.addEventListener('change', ()=>{ renderPreview(); updatePDFButton(); });

  // Assinatura — canvas calibrado
  const canvas = document.getElementById('signaturePad');
  function resizeCanvasForHiDPI(){
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const rect = canvas.getBoundingClientRect();
    canvas.style.width  = rect.width  + 'px';
    canvas.style.height = rect.height + 'px';
    canvas.width  = Math.floor(rect.width  * ratio);
    canvas.height = Math.floor(rect.height * ratio);
    const ctx = canvas.getContext('2d');
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
    ctx.clearRect(0, 0, rect.width, rect.height);
    ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, rect.width, rect.height);
  }
  let signaturePad;
  function initSignature(){
    signaturePad = new window.SignaturePad(canvas, {
      backgroundColor: 'rgba(0,0,0,0)',
      penColor: '#111827', minWidth: 0.7, maxWidth: 2.2, throttle: 0,
      onEnd: ()=>{ renderPreview(); updatePDFButton(); }
    });
    const prevent = (e)=>{ e.preventDefault(); };
    canvas.addEventListener('touchstart', prevent, {passive:false});
    canvas.addEventListener('touchmove', prevent, {passive:false});
    canvas.addEventListener('touchend', prevent, {passive:false});
  }
  window.addEventListener('resize', ()=>{
    if(document.getElementById('s6').classList.contains('active')){
      const data = signaturePad ? signaturePad.toData() : null;
      resizeCanvasForHiDPI();
      if(signaturePad){ signaturePad.clear(); if (data && data.length) signaturePad.fromData(data); }
    }
  });
  document.getElementById('btnLimpar')?.addEventListener('click', (e)=>{
    e.preventDefault(); if(signaturePad) signaturePad.clear();
    document.getElementById('pv_assinatura').src=''; updatePDFButton(); renderPreview();
  });

  // Recorte fino da assinatura
  function cropTransparent(dataURL, padding=6, threshold=1){
    return new Promise(resolve=>{
      const img = new Image();
      img.onload = ()=>{
        const w=img.width,h=img.height;
        const c=document.createElement('canvas'); c.width=w; c.height=h;
        const ctx=c.getContext('2d',{willReadFrequently:true}); ctx.drawImage(img,0,0);
        const dt=ctx.getImageData(0,0,w,h).data;
        let top=h,left=w,right=0,bottom=0;
        for(let y=0;y<h;y++) for(let x=0;x<w;x++){
          const a=dt[(y*w+x)*4+3]; if(a>threshold){ if(x<left)left=x; if(x>right)right=x; if(y<top)top=y; if(y>bottom)bottom=y; }
        }
        if(right<left||bottom<top){ resolve(''); return; }
        left=Math.max(0,left-padding); top=Math.max(0,top-padding);
        right=Math.min(w-1,right+padding); bottom=Math.min(h-1,bottom+padding);
        const cw=right-left+1,ch=bottom-top+1;
        const c2=document.createElement('canvas'); c2.width=cw; c2.height=ch;
        c2.getContext('2d').drawImage(c,left,top,cw,ch,0,0,cw,ch);
        resolve(c2.toDataURL('image/png'));
      };
      img.src = dataURL;
    });
  }

  async function renderPreview(){
    const v = {
      titular_nome: $('#titular_nome')?.value.trim() || '',
      titular_cpf: $('#titular_cpf')?.value.trim() || '',
      ultimos4: onlyDigits($('#ultimos4')?.value || '').slice(0,4),
      bandeira: $('#bandeira')?.value.trim() || '',
      contratante_nome: $('#contratante_nome')?.value.trim() || '',
      contratante_cpf: $('#contratante_cpf')?.value.trim() || '',
      aceite: $('#aceite')?.checked || false,
      data: $('#data_assinatura')?.value || ''
    };

    // Cabeçalho
    $('#doc_id').textContent   = docId();
    $('#doc_data').textContent = (v.data || '').split('-').reverse().join('/');

    // Campos PDF
    $('#pv_titular_nome').textContent = U(v.titular_nome);
    $('#pv_titular_cpf').textContent  = v.titular_cpf;
    $('#pv_u4').textContent           = v.ultimos4;
    $('#pv_bandeira').textContent     = U(v.bandeira || '—');
    $('#pv_contratante_nome').textContent = U(v.contratante_nome);
    $('#pv_contratante_cpf').textContent  = v.contratante_cpf;

    // Assinatura
    if (signaturePad && !signaturePad.isEmpty()) {
      const png = await cropTransparent(signaturePad.toDataURL('image/png'), 6);
      $('#pv_assinatura').src = png;
    } else {
      $('#pv_assinatura').src = '';
    }
  }

  function isValidCPF(cpf){
    cpf = onlyDigits(cpf);
    if (cpf.length !== 11) return false;
    if (/^(\d)\1{10}$/.test(cpf)) return false;
    let s=0,r;
    for(let i=1;i<=9;i++){ s+=parseInt(cpf.substring(i-1,i))*(11-i); }
    r=(s*10)%11; if(r===10||r===11) r=0; if(r!==parseInt(cpf.substring(9,10))) return false;
    s=0;
    for(let i=1;i<=10;i++){ s+=parseInt(cpf.substring(i-1,i))*(12-i); }
    r=(s*10)%11; if(r===10||r===11) r=0;
    return r===parseInt(cpf.substring(10,11));
  }

  function validateForPDF(v){
    if (!v.titular_nome) return 'Informe o nome completo do TITULAR.';
    if (!v.contratante_nome) return 'Informe o nome completo do CONTRATANTE.';
    if (!isValidCPF(v.titular_cpf)) return 'CPF do TITULAR inválido.';
    if (!isValidCPF(v.contratante_cpf)) return 'CPF do CONTRATANTE inválido.';
    if (!v.ultimos4 || v.ultimos4.length !== 4) return 'Informe os 4 últimos dígitos do cartão.';
    if (!v.bandeira) return 'Informe a bandeira do cartão.';
    if (!v.aceite) return 'Você precisa aceitar o termo.';
    if (!signaturePad || signaturePad.isEmpty()) return 'Assine no quadro antes de gerar o PDF.';
    return null;
  }

  function getValues(){
    return {
      titular_nome: $('#titular_nome')?.value.trim() || '',
      titular_cpf: $('#titular_cpf')?.value.trim() || '',
      ultimos4: onlyDigits($('#ultimos4')?.value || '').slice(0,4),
      bandeira: $('#bandeira')?.value.trim() || '',
      contratante_nome: $('#contratante_nome')?.value.trim() || '',
      contratante_cpf: $('#contratante_cpf')?.value.trim() || '',
      aceite: $('#aceite')?.checked || false,
      data: $('#data_assinatura')?.value || ''
    };
  }

  function updatePDFButton(){
    const btn = document.getElementById('btnPDF');
    if (!btn) return;
    const v = getValues();
    const finalActive = document.getElementById('s7').classList.contains('active');
    btn.disabled = !(v.aceite && signaturePad && !signaturePad.isEmpty() && finalActive);
  }

  // ======== Exporta A4 (prioriza largura) ========
  async function generatePDF(){
    const v = getValues();
    const err = validateForPDF(v);
    if (err){ alert(err); return; }

    await renderPreview(); // garante #printArea atualizado

    const area = document.getElementById('printArea');
    const canvasImg = await html2canvas(area, { scale: 2, useCORS: true, backgroundColor:'#ffffff' });
    const imgWpx = canvasImg.width, imgHpx = canvasImg.height;

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','mm','a4');

    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const margin = 6; // mm
    const maxW = pageW - margin*2;
    const maxH = pageH - margin*2;

    let scale = maxW / imgWpx;          // cabe pela largura
    if (imgHpx * scale > maxH) scale = maxH / imgHpx; // fallback se estourar altura

    const imgWmm = imgWpx * scale;
    const imgHmm = imgHpx * scale;
    const x = (pageW - imgWmm) / 2;
    const y = (pageH - imgHmm) / 2;

    const imgData = canvasImg.toDataURL('image/png');
    pdf.addImage(imgData, 'PNG', x, y, imgWmm, imgHmm, undefined, 'FAST');

    const [yS,mS,dS] = (document.getElementById('data_assinatura').value || '').split('-');
    const hoje = new Date();
    const dd = (dS || String(hoje.getDate()).padStart(2,'0'));
    const mm2 = (mS || String(hoje.getMonth()+1).padStart(2,'0'));
    const yy = (yS || String(hoje.getFullYear()));
    const dataStr = `${dd}${mm2}${yy}`;
    const nome = slugUpper(document.getElementById('contratante_nome').value);
    const filename = `TERMOCARTAO_${nome}_${dataStr}.pdf`;
    pdf.save(filename);
  }

  // Navegação
  document.getElementById('n0').onclick = ()=> go(1);
  document.getElementById('n1').onclick = ()=> go(2);
  document.getElementById('n2').onclick = ()=> go(3);
  document.getElementById('n3').onclick = ()=> go(4);
  document.getElementById('n4').onclick = ()=> go(5);
  document.getElementById('n5').onclick = ()=> go(6);
  document.getElementById('n6').onclick = ()=>{
    if (!document.getElementById('aceite').checked){ alert('Você precisa aceitar o termo para continuar.'); return; }
    if (!signaturePad || signaturePad.isEmpty()){ alert('Por favor, assine para continuar.'); return; }
    go(7);
  };

  document.getElementById('p1').onclick = ()=> go(0);
  document.getElementById('p2').onclick = ()=> go(1);
  document.getElementById('p3').onclick = ()=> go(2);
  document.getElementById('p4').onclick = ()=> go(3);
  document.getElementById('p5').onclick = ()=> go(4);
  document.getElementById('p6').onclick = ()=> go(5);
  document.getElementById('p7').onclick = ()=> go(6);

  document.getElementById('btnPDF').addEventListener('click', e=>{ e.preventDefault(); generatePDF(); });
  document.getElementById('btnReset').addEventListener('click', e=>{ e.preventDefault(); if(confirm('Limpar todos os campos?')) location.reload(); });

  // Boot
  (async function boot(){
    mountDots();
    await loadLogo();
    setTodayBR();
    requestAnimationFrame(()=>{ initSignature(); go(0); });
  })();
</script>
</body>
</html>
